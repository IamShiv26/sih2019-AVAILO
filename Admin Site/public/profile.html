<!doctype html>

<html lang="en">
  <head>
    <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>AVAIL-O</title>
  
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.indigo-pink.min.css">
    <!-- <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"> -->
    <link rel="stylesheet" href="./src/css/app.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-tile" content="PictureIt!">
  <meta name="msapplication-TitleColor" content="#fff">
  <meta name="theme-color" content="#3f51b5">
</head>
   
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABPbaU11DPf0IaP5tK7EUSzECqkoCNQfs&callback=initMap">
    </script>
    
    
    <style>
     body {
      font-family: 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .responsive {
      max-width: 100%;
      height: auto;
    }
    .c-btn {
      font-size: 14px;
      text-transform: capitalize;
      font-weight: 600;
      display: inline-block;
      line-height: 36px;
      cursor: pointer;
      text-align: center;
      text-transform: uppercase;
      min-width: 88px;
      height: 36px;
      margin: 10px 8px;
      padding: 0 8px;
      text-align: center;
      letter-spacing: .5px;
      border-radius: 2px;
      background: #F1F1F1;
      color: #393939;
      transition: background 200ms ease-in-out;
      box-shadow: 0 3.08696px 5.82609px 0 rgba(0, 0, 0, 0.16174), 0 3.65217px 12.91304px 0 rgba(0, 0, 0, 0.12435);
    }

    .c-btn--flat {
      background: transparent;
      margin: 10px 8px;
      min-width: 52px;
    }

    .c-btn:hover {
      background: rgba(153, 153, 153, 0.2);
      color: #393939;
    }

    .c-btn:active {
      box-shadow: 0 9.6087px 10.78261px 0 rgba(0, 0, 0, 0.17217), 0 13.56522px 30.3913px 0 rgba(0, 0, 0, 0.15043);
    }

    .c-btn--flat, .c-btn--flat:hover, .c-btn--flat:active {
      box-shadow: none;
    }
    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }




    </style>
  </head>
  <body>

    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
              <!-- Title -->
              <span class="mdl-layout-title">AVAIL-O</span>
              <!-- Add spacer, to align navigation to the right -->
              <div class="mdl-layout-spacer"></div>
              <!-- Navigation. We hide it in small screens. -->
              <nav class="mdl-navigation mdl-layout--large-screen-only">
                <a class="mdl-navigation__link" href="./index.html">Home</a>
                <a class="mdl-navigation__link" href = "./addOfficer.html">Add Officers</a>
                <a class="mdl-navigation__link" href="#">About</a>
              </nav>
              <form action="#">
                  <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
                      <label class="mdl-button mdl-js-button mdl-button--icon" for="site-search">
                              <i class="material-icons">search</i>
                          </label>
                          <div class="mdl-textfield__expandable-holder">
                              <input class="mdl-textfield__input" type="search" id="site-search" />
                              <label class="mdl-textfield__label" for="site-search">Search</label>
                          </div>
                      </div>
              </form>
            </div>
          </header>
          <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">AVAIL-O</span>
            <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="./index.html">Home</a>
                <a class="mdl-navigation__link" href = "./addOfficer.html">Add Officers</a>
              <a class="mdl-navigation__link" href="#">About</a>
            </nav>
          </div>
      <main class="mdl-layout__content mdl-color--grey-100">
        <div class="mdl-grid demo-content">
         
          <div class=" mdl-shadow--2dp mdl-color--white mdl-cell mdl-cell--8-col" style = "padding: 10px">
           <p class = "mdl-card__title-text" style = "font-size: 20px">Name:<span id="name"></span> </p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Designation: <span id="designation"></span> </p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Department: <span id="department"></span></p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Description: <span id="description"></span></p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Email: <span id="email"></span></p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Address: <span id="address"></span></p><br>
           <!-- <a href = "https://www.google.com/maps/@28.5331128,77.1527382,18.64z" target="_blank"><img src = " https://maps.googleapis.com/maps/api/staticmap?center=28.5358315,77.1544826&zoom=17&size=1000x250&maptype=roadmap&markers=color:red%7Clabel:Off%7C28.5358315,77.1544826&key=AIzaSyCrqUlbATGozehIWTVim5OoKm3VWBiFd4s" class = "responsive"></a><br><br> -->
           <p>Office Location</p><a id="maplink" target="_blank"><img id="mapimage" class = "responsive"></a><br><br>
           <p>Current Location</p><a id="currentmaplink" target="_blank"><img id="currentmap" class = "responsive"></a><br><br>
            <span id="current"></span>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Office hours: <span id="officerhours"></span></p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Phone Number: <span id="phno"></span></p><br>
           <p class = "mdl-card__title-text" style = "font-size: 20px">Phone Extension: <span id="phex"></span></p>
              
          </div>
          <div class="demo-cards mdl-cell mdl-cell--4-col mdl-cell--8-col-tablet mdl-grid mdl-grid--no-spacing" id="officerSide">
            <div class="demo-updates mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--12-col-desktop">
              <div class="mdl-card__title mdl-card--expand mdl-color--teal-300">
                <h2 class="mdl-card__title-text">Update Availability</h2>
                
              </div>
              
              <div class="mdl-card__supporting-text mdl-color-text--grey-600">
                    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="checkLabel" for="switch-1">
                    <input type="checkbox" id="switch-1" class="mdl-switch__input mdl-switch mdl-js-switch mdl-js-ripple-effect mdl-js-ripple-effect--ignore-events is-upgraded ">
                    <span class="mdl-switch__label"></span>
                   </label>
              </div>
              
            </div>
            <div class="demo-separator mdl-cell--1-col"></div>
            <div class="demo-options mdl-card mdl-color--orange-400 mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--3-col-tablet mdl-cell--12-col-desktop">
              <div class="mdl-card__supporting-text mdl-color-text--blue-grey-50">
                <h2 class="mdl-card__title-text">Upcoming Events</h2> <br>
                  <div id = "events"></div>
                      
  
              </div>
              
            </div>
          </div>
        </div>
      </main>
    </div>
    <script defer src="./src/js/material.min.js"></script>
    <script src="./src/js/promise.js"></script>
    <script src="./src/js/fetch.js"></script>
    <script src="./src/js/idb.js"></script>
    <script src="./src/js/utility.js"></script>
    <script src="./src/js/app.js"></script>
     <script type="text/javascript">
      var url;
      //window.onload = async function(){
        url = new URL(window.location.href);
        console.log(typeof url);

      var id = url.search.substring(4);
      var datajson;
        
      fetch('https://availo-api.herokuapp.com/coords/' + id).then(result => {
        return result.json();
      }).then(json => {
        var coords = json["location"]["latitude"] + "," + json["location"]["longitude"];
        $("#currentmap").attr('src', 'https://maps.googleapis.com/maps/api/staticmap?center=' + coords + '&zoom=17&size=1000x250&maptype=roadmap&markers=color:red%7Clabel:Off%7C'+coords+'&key=AIzaSyABPbaU11DPf0IaP5tK7EUSzECqkoCNQfs');
        $("#currentmaplink").attr('href', 'https://www.google.com/maps/@' + coords + ',25z')
        
      });

      // document.querySelector("#current").textContent = crd.latitude + " "+crd.longitude;
      fetch("https://availo-api.herokuapp.com/officers/"+id).then(function(res){
          return res.json();
      }).then(function(data){
        //console.log(data);
        datajson = data;
        writeData('officer-cards',datajson).then(function(res){
            console.log("ID Added");
        });
        document.querySelector("#name").textContent = data.name;
      document.querySelector("#email").textContent = data.email;
      document.querySelector("#description").textContent = data.description;
      document.querySelector("#designation").textContent = data.designation;
      document.querySelector("#department").textContent = data.department;

       var startdate = new Date(data["workingHours"]["startTime"]);
        var startTime = clean(startdate.getHours())  + ":" + clean(startdate.getMinutes()) + ":" + clean(startdate.getSeconds());

        var enddate = new Date(data["workingHours"]["endTime"]);
        var endTime = clean(enddate.getHours())  + ":" + clean(enddate.getMinutes()) + ":" + clean(enddate.getSeconds());

        $("#officerhours").html($("#officerhours").html() + startTime + " - " + endTime);
        $("#address").html($("#address").html() + data["address"]);
      document.querySelector("#phno").textContent = data.phoneNo;
      document.querySelector("#phex").textContent = data.phoneExtension;
      if(data.status.toLowerCase() == "avl"){
        document.querySelector('#switch-1').checked = true;
        document.querySelector("#checkLabel").className = 'mdl-switch mdl-js-switch mdl-js-ripple-effect mdl-js-ripple-effect--ignore-events is-upgraded is-checked';
      }
      else if(data.status.toLowerCase() =="na"){
        document.querySelector('#switch-1').checked = false; 
        document.querySelector("#checkLabel").className = 'mdl-switch mdl-js-switch mdl-js-ripple-effect mdl-js-ripple-effect--ignore-events is-upgraded';
      }
      console.log(datajson);
      var coords = datajson["officeLocation"]["latitude"] + "," + datajson["officeLocation"]["longitude"];
        $("#mapimage").attr('src', 'https://maps.googleapis.com/maps/api/staticmap?center=' + coords + '&zoom=17&size=1000x250&maptype=roadmap&markers=color:red%7Clabel:Off%7C'+coords+'&key=AIzaSyABPbaU11DPf0IaP5tK7EUSzECqkoCNQfs');
        $("#maplink").attr('href', 'https://www.google.com/maps/@' + coords + ',18.64z')
        fetch("https://availo-api.herokuapp.com/calendar", {
          method : "POST",
          headers : {
            "Content-Type" : "application/json"
          },
          body:JSON.stringify({
              email : data.email
          })
        }).then(function(res){
          return res.json();
        }).then(function(json){
          console.log(json);
          var str = "";
          var d=new Date();
          for (var keys in json)
          { 
            str += Date(json[keys]["start"]).toLocaleString()  + " to " + Date(json[keys]["end"]).toLocaleString() + json[keys]["summary"] + "\n";
          }
          console.log(str);
          document.querySelector("#events").textContent = str;

        })
        .catch(function(err){
          console.log("calendar not displayed", err);
        });



      });

      readAllData("login-tokens").then(function(data){
        if(data.length!=0){
            var options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            var id1 = navigator.geolocation.watchPosition(function(pos){
                        var crd = pos.coords;
                        console.log(crd);
                        writeData('current-coords',{
                            latitude:crd.latitude,
                            longitude:crd.longitude,
                            id:new Date()
                        }).then(function(res){
                            console.log("Coords Stored",res);
                        })
                        
                    }, function(err){
                        console.warn('ERROR(' + err.code + ')' + err.message);
                    }, options);
                }
            });


      //var key1;
//       readAllData('login-tokens').then(function(data){
//         if(data.length!=0){
//           console.log("Data Read", data);
//           console.log(data[0].token);
//           key1 = data[0].token;
//         }
//         else {
//           document.querySelector("#officerSide").style.display = 'none';
//         }
// });
       document.querySelector('#switch-1').addEventListener('change', function(){
        console.log(this.checked);
        var status1;
        if(this.checked == true){
            status1 = "avl";
        }
        else{
          status1 = "na";
        }
        console.log(status1);
        console.log(id);
        fetch("https://availo-api.herokuapp.com/admin/update", {
          method : "PATCH",
          headers : {
            "Content-Type" : "application/json"
          },
          body:JSON.stringify({
              _id : datajson._id,
              status : status1
          })
        }).then(function(res){
          console.log("Status Updated!",res);
        }).catch(function(err){
          console.log("Error in updating Status", err);
        });
       });

       //console.log("primting" + datajson);
       function clean(x){
          if(x < 10) return '0' + x;
          return x;
        }
        
     </script>
  <script src="./src/js/index.js"></script>
  </body>
</html>
